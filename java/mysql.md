# Mysql

## 版本
Mysql现在主要使用的是5.7版本


## 变种
* Drizzle：可用性增强，但很多地方不兼容
* MariaDB：Mysql之父在mysql被收购时创立，是Mysql的超集，完全兼容
* Percona：性能增强，《高性能Mysql》的作者创立
* Postgre：稳定性极强，抗压；数据类型丰富
* SQLite：小巧，嵌入式


## 架构
![mysql+20211112164214](https://raw.githubusercontent.com/loli0con/picgo/master/images/mysql%2B20211112164214.png%2B2021-11-12-16-42-16)

### 连接层
主要完成一些类似于连接处理、授权认证以及相关的安全等。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供处理线程。同样在该层上可以实现基于 SSL 的安全链接，服务器也会为安全接入的每个客户端验证它所具有的操作权限。

Oracle推荐max_connections（最大连接数）最好设置为CPU的数量的两倍。

### 服务层
* Management Serveices & Utilities：系统管理和控制工具。
* SQL Interface：SQL 接口。接受用户的 SQL 命令，并且返回用户需要查询的结果。
* Parser：解析器。SQL 命令传递到解析器的时候会被解析器验证和解析。
* Optimizer：查询优化器。SQL 语句在查询之前会使用查询优化器对查询进行优化，比如有 where 条件时，优化器来决定先投影还是先过滤。
* Cache & Buffer：查询缓存。如果查询缓存有命中的查询结果，查询语句就可以直接去查询缓存中取数据。这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key 缓存，权限缓存等。现在默认不使用，弊大于利。

### 引擎层
存储引擎层，存储引擎真正的负责了 MySQL 中数据的存储和提取，服务器通过 API 与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取，这就是插件式存储引擎。

* InnoDB：短事务
* MyISAM
* XtraDB：InnoDB的强化版
* TokuDB：替换B+树为分型树，针对写优化
* Infobright：按列存储

存储引擎是针对表的，修改存储引擎时全表加锁，然后遍历每一行并插入新表。

### 存储层
数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互。




## 目录/文件

### 启动Mysql
* bin/mysqld
* bin/mysqld_safe
* support-files/mysql.server

### 参数
查看参数：show variables like "%参数%"
设置参数：set global/session 参数名=参数值

#### 参数类型
*是否可修改：
  * 静态
  * 动态
* 作用域：
  * 全局
  * 会话

#### 常用参数
* datadir：mysql 数据库文件的存放路径
* basedir：安装目录
* pid-file：进程 pid 文件
* socket：本地连接时用的 unix 套接字文件
* log-error：mysql 错误日志路径
* log-bin：mysql 二进制日志(写入日志)，记录所有写入
* general-log：普通查询日志


#### 参数列表
https://dev.mysql.com/doc/refman/5.7/en/dynamic-system-variables.html


### 数据目录
show variables like "datadir"

用途：
* 库在文件系统中的表示
* 表在文件系统中的表示(innode/myisam)
* 常见的日志文件
  * 错误日志
  * 慢查询日志：data/主机名-slow.log
  * 查询日志：data/主机名.log
  * 二进制日志(写日志)：
* 其他的数据文件

#### innodb
表定义：xxx.frm
表空间：xxx.ibd

#### myisam
表定义：xxx.frm
表数据：xxx.myd
表索引：xxx.myi


##### 表空间
存在记录数据的位置，以页为单位，落地到一个或者多个文件 





## 事务
数据库事务(transaction)是访问并可能操作各种数据项的一个数据库操作序列，这些操作要么全部执行，要么全部不执行，是一个不可分割的工作单位。

### 参考
1. https://zhuanlan.zhihu.com/p/117476959
2. https://draveness.me/mysql-transaction/
3. https://tech.meituan.com/2014/08/20/innodb-lock.html

### 四大特性
* 原子性：事务作为一个整体被执行，包含在其中的对数据库的操作要么全部被执行，要么都不执行。
* 一致性：事务应确保数据库的状态从一个一致状态转变为另一个一致状态。一致状态的含义是数据库中的数据应满足完整性约束。
* 持久性：已被提交的事务对数据库的修改应该永久保存在数据库中。
* 隔离性：多个事务并发执行时，一个事务的执行不应影响其他事务的执行。

### 事务并发执行时存在的问题
* 脏读：脏读指的是读到了其他事务未提交的数据，未提交意味着这些数据可能会回滚，也就是可能最终不会存到数据库中，也就是不存在的数据。读到了并不一定最终存在的数据，这就是脏读。
* 不可重复读：不可重复读指的是在同一事务内，不同的时刻读到的同一批数据可能是不一样的，可能会受到其他事务的影响，比如其他事务改了这批数据并提交了。通常针对数据更新（UPDATE）操作。
* 幻读：幻读是针对数据插入（INSERT）操作来说的。假设事务A对某些行的内容作了更改，但是还未提交，此时事务B插入了与事务A更改前的记录相同的记录行，并且在事务A提交之前先提交了，而这时，在事务A中查询，会发现好像刚刚的更改对于某些数据未起作用，但其实是事务B刚插入进来的，让用户感觉很魔幻，感觉出现了幻觉，这就叫幻读。

### 隔离级别
![mysql+20211112231521](https://raw.githubusercontent.com/loli0con/picgo/master/images/mysql%2B20211112231521.png%2B2021-11-12-23-15-22)




## 范式
范式来自英文Normal Form，简称NF。想要设计一个好的关系，必须使关系满足一定的约束条件，此约束条件已经形成了规范，分成几个等级，一级比一级要求得严格。满足这些规范的数据库是简洁的、结构明晰的。

六种范式：
* 第一范式（1NF）
* 第二范式（2NF）
* 第三范式（3NF）
* 巴斯-科德范式（BCNF）
* 第四范式（4NF）
* 第五范式（5NF，又称完美范式）

### 第一范式
1. 每一列属性都是不可再分的属性值，确保每一列的原子性
2. 两列的属性相近、近似或者一样，尽量合并属性一样的列，确保不产生冗余数据
3. 单一属性的列为基本数据类型构成
4. 设计出来的表都是简单的二维表

### 第二范式
1. 第二范式是在第一范式的基础上建立起来的
2. 第二范式要求实体的属性完全依赖于主关键词。所谓完全依赖是指不能存在仅依赖主关键字一部分的属性；如果存在，那么这个属性和主关键字的这一部分应该分离出来形成一个新的实体，新的实体和原实体之间是一对多的关系

### 第三范式
1. 满足第三范式必须先满足第二范式
2. 第三范式要求一个数据库表中不包含已在其他表中包含的非主关键字信息，即数据不能存在传递关系，即每个属性都跟主键有直接关系而不是间接关系


### 反范式
所谓的反范式设计，就是针对范式化设计而言的。

1. 为了性能和读取效率而适当的违反对数据库设计范式的要求
2. 为了查询的性能，允许存在部分冗余数据。换句话说，反范式设计就是使用空间换时间

## 索引
官方定义：索引是帮助Mysql高效获取数据的数据结构
本质：索引是数据结构
作用：高效获取数据