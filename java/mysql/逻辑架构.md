# 逻辑架构
![逻辑架构+![逻辑架构+20231114155041](httpsraw.githubusercontent.comloli0conpicgomasterimages%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%2B20231114155041.png%2B2023-11-14-15-50-42)](https://raw.githubusercontent.com/loli0con/picgo/master/images/%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%2B!%5B%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%2B20231114155041%5D(httpsraw.githubusercontent.comloli0conpicgomasterimages%25E9%2580%25BB%25E8%25BE%2591%25E6%259E%25B6%25E6%259E%2584%252B20231114155041.png%252B2023-11-14-15-50-42).png%2B2023-11-14-15-55-22)

## 连接层
系统(客户端)访问 MySQL 服务器前，做的第一件事就是建立 TCP 连接。

经过三次握手建立连接成功后，MySQL 服务器对 TCP 传输过来的账号密码做身份认证、权限获取。
* 用户名或密码不对，会收到一个Access denied for user错误，客户端程序结束执行
* 用户名密码认证通过，会从权限表查出账号拥有的权限与连接关联，之后的权限判断逻辑，都将依赖于此时读到的权限

TCP 连接收到请求后，必须要分配给一个线程专门与这个客户端的交互。所以还会有个线程池，去走后面的流程。每一个连接从线程池中获取线程，省去了创建和销毁线程的开销。

## 服务层

### SQL Interface: SQL接口
* 接收用户的SQL命令，并且返回用户需要查询的结果。比如SELECT ... FROM就是调用SQL Interface
* MySQL支持DML(数据操作语言)、DDL(数据定义语言)、存储过程、视图、触发器、自定义函数等多种SQL语言接口

### Parser: 解析器
* 在解析器中对SQL语句进行语法分析、语义分析。将SQL语句分解成数据结构，并将这个结构传递到后续步骤，以后SQL语句的传递和处理就是基于这个结构的。如果在分解构成中遇到错误，那么就说明这个SQL语句是不合理的。
* 在SQL命令传递到解析器的时候会被解析器验证和解析，并为其创建**语法树**，并根据数据字典丰富查询语法树，会**验证该客户端是否具有执行该查询的权限**。创建好语法树后，MySQL还会对SQl查询进行语法上的优化，进行查询重写。

### Optimizer: 查询优化器
* SQL语句在语法解析之后、查询之前会使用查询优化器确定SQL语句的执行路径，生成一个**执行计划**。
* 这个执行计划表明应该**使用哪些索引**进行查询(全表检索还是使用索引检索)，表之间的连接顺序如何，最后会按照执行计划中的步骤调用存储引擎提供的方法来真正的执行查询，并将查询结果返回给用户。
* 它使用“**选取-投影-连接**”策略进行查询。例如:`SELECT id,name FROM student WHERE gender = '女';`。
  * 这个SELECT查询先根据WHERE语句进行**选取**，而不是将表全部查询出来以后再进行*gender*过滤
  * 这个SELECT查询先根据*id*和*name*进行属性**投影**，而不是将属性全部取出以后再进行过滤
  * 这个SELECT查询将这两个查询条件**连接**起来生成最终查询结果

### Caches & Buffers: 查询缓存组件
* MySQL内部维持着一些Cache和Buffer，比如Query Cache用来缓存一条SELECT语句的执行结果，如果能够在其中找到对应的查询结果，那么就不必再进行查询解析、优化和执行的整个过程了，直接将结果反馈给客户端。
* 这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key缓存，权限缓存等 。
* 这个查询缓存可以在**不同客户端之间共享**。
* 从MySQL 5.7.20开始，不推荐使用查询缓存，并在**MySQL8**中

## 引擎层
插件式存储引擎层(Storage Engines)，**真正的负责了MySQL中数据的存储和提取，对物理服务器级别维护的底层数据执行操作**，服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取。

MySQL默认支持的存储引擎如下:
![逻辑架构+20231114161438](https://raw.githubusercontent.com/loli0con/picgo/master/images/%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%2B20231114161438.png%2B2023-11-14-16-14-39)