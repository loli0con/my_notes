# 术语

## 关注点
1. 关注点是指在应用程序中的某个特定功能或兴趣区域内的任务或功能。它可以是应用程序的任何部分，负责完成特定的业务逻辑或功能。
2. 关注点通常是应用程序的不同模块或组件的功能单元，它们需要被独立地开发、测试和维护。

## 横切关注点 Cross-cutting concerns
1. 横切关注点指的是一些具有横越多个模块的行为，使用传统的软件开发方法不能够达到有效的模块化的一类特殊关注点。
2. 横切关注通常包括日志记录、安全性、事务管理等与业务逻辑无关但对整个应用程序都很重要的方面。
3. 这个概念不是语法层面的，而是根据附加功能的逻辑上的需要：有十个附加功能，就有十个横切关注点。

面向切面的程序设计将代码逻辑切分为不同的模块（即关注点，指一段特定的逻辑功能）。几乎所有的编程思想都涉及代码功能的分类，将各个关注点（Concern）封装成独立的抽象模块（如函数、过程、模块、类以及方法等），后者又可供进一步实现、封装和重写。部分关注点“横切”程序代码中的数个模块，即在多个模块中都有出现，它们即被称作横切关注点（Cross-cutting concerns, Horizontal concerns）。

![aop+20231007090012](https://raw.githubusercontent.com/loli0con/picgo/master/images/aop%2B20231007090012.png%2B2023-10-07-09-00-13)

## 连接点 Joinpoint
连接点描述的是程序执行的某个特定位置。如一个类的初始化前、初始化后，或者类的某个方法调用前、调用后、方法抛出异常后等等。一个类或一段程序代码拥有一些具有边界性质的特定点，这些特定点就称为连接点。连接点用来定义在目标程序的哪里通过AOP加入新的逻辑。

连接点由两个信息确定：第一是用方法表示的程序执行点（即程序执行流程中的某个点。如执行某个语句或者语句块、执行某个方法、装载某个类、抛出某个异常等）；第二是用相对点表示的方位（“前”或“后”）。

## 切入点 Pointcut
切入点是一个连接点的过滤条件，AOP 通过切点定位到特定的连接点。每个类都拥有多个连接点：例如 UserService类中的所有方法实际上都是连接点，即连接点是程序类中客观存在的事物。类比：连接点相当于数据库中的记录，切点相当于查询条件。切点和连接点不是一对一的关系，一个切点匹配多个连接点，切点通过 org.springframework.aop.Pointcut 接口进行描述，它使用类和方法作为连接点的查询条件。

AOP技术通过切入点定位到特定的连接点。我们通常使用明确的类和方法名称，或是利用正则表达式定义所匹配的类和方法名称来指定这些切点。Spring中通过**切入点表达式**来制定规则。

## 通知 Advice
通知，描述切入的时机和内容。每一个横切关注点上要做的事情都需要写一个方法来实现，这样的方法就叫通知方法。通知的类型有：
* 前置通知Before：在被代理的目标方法**前**执行
* 返回通知AfterReturning：在被代理的目标方法**成功结束**后执行
* 异常通知AfterThrowing：在被代理的目标方法**异常结束**后执行
* 后置通知After：在被代理的目标方法**最终结束**后执行
* 环绕通知Around：使用try...catch...finally结构围绕**整个**被代理的目标方法，包括上面四种通知对应的所有位置

![aop+20231007155716](https://raw.githubusercontent.com/loli0con/picgo/master/images/aop%2B20231007155716.png%2B2023-10-07-15-57-17)

## 通知器 Advisor
通知器由一个切入点和一个通知组成，通知就是增强的那部分功能代码。通知器实现了通知接口。

## 切面 Aspect
切面是**通知**和**切点**的结合，**通知**和**切点**共同定义了切面的全部内容 —— 它是什么，在何时和何处完成其功能。Spring AOP就是负责实施切面的框架，切面是封装了通知方法的类。

![aop+20231007160610](https://raw.githubusercontent.com/loli0con/picgo/master/images/aop%2B20231007160610.png%2B2023-10-07-16-06-11)

## 目标 Target
目标是被代理/通知的对象，即真正执行业务的核心逻辑对象。

## 代理 Proxy
一个类被AOP织入增强后产生的结果类，即代理类，是客户端持有的增强后的对象引用。

## 织入 Weaving
织入指的是把新增的功能用于目标对象，创建代理对象的过程，将切面整合到程序的执行流程的过程。

在目标对象的生命周期里有多个点可以进行织入：
* 编译期：切面在目标类编译时被织入。这种方式需要特殊的编译器。AspectJ 的织入编译器就是以这种方式织入切面的。
* 类加载期：切面在目标类加载到 JVM 时被织入。这种方式需要特殊的类加载器（ClassLoader），它可以在目标类被引入应用之前增强该目标类的字节码。AspectJ 5 的加载时织入（load-time weaving，LTW）就支持以这种方式织入切面。
* 运行期：切面在应用运行的某个时刻被织入。一般情况下，在织入切面时，AOP 容器会为目标对象动态地创建一个代理对象。Spring AOP 就是以这种方式织入切面的。

Spring的AOP实现基于JVM的动态代理。由于JVM的动态代理要求必须实现接口，如果一个普通类没有业务接口，就需要通过CGLIB或者Javassist这些第三方库实现（Spring封装了这些过程）。

### 动态代理
![aop+20231007162338](https://raw.githubusercontent.com/loli0con/picgo/master/images/aop%2B20231007162338.png%2B2023-10-07-16-23-38)

动态代理分为JDK动态代理和cglib动态代理：
* 当目标类有接口的情况使用JDK动态代理和cglib动态代理，没有接口时只能使用cglib动态代理
* JDK动态代理动态生成的代理类会在com.sun.proxy包下，类名为$proxy1，和目标类实现相同的接口
* cglib动态代理动态生成的代理类会和目标在在相同的包下，会继承目标类
* 动态代理（InvocationHandler）：JDK原生的实现方式，需要被代理的目标类必须实现接口。因为这个技术要求**代理对象和目标对象实现同样的接口**。
* cglib：通过**继承被代理的目标类**实现代理，所以不需要目标类实现接口。

### AspectJ
AspectJ是AOP思想的一种实现。本质上是静态代理，**将代理逻辑“织入”被代理的目标类编译得到的字节码文件**，所以最终效果是动态的。Spring只是借用了AspectJ中的注解。