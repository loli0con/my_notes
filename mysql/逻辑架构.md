# 逻辑架构
![逻辑架构+20240226194515](https://raw.githubusercontent.com/loli0con/picgo/master/images/逻辑架构+20240226194515.png+2024-02-26-19-45-16)

## Connectors
Connectors指的是不同语言中与SQL的交互。MySQL首先是一个网络程序，在TCP之上定义了自己的应用层协议。所以要使用MySQL，需要编写代码，与MySQL Server建立TCP连接，之后按照其定义好的协议进行交互。或者更方便的办法是调用SDK，比如Native C API、JDBC、PHP等各语言的MySQL Connector，或者通过ODBC。但通过SDK来访问MySQL，本质上还是在TCP连接上通过MySQL协议跟MySQL进行交互。

## 第一层：连接层
系统(客户端)访问 MySQL 服务器前，做的第一件事就是建立 TCP 连接。

经过三次握手建立连接成功后，MySQL 服务器对 TCP 传输过来的账号密码做身份认证、权限获取。
* 用户名或密码不对，会收到一个Access denied for user错误，客户端程序结束执行
* 用户名密码认证通过，会从权限表查出账号拥有的权限与连接关联，之后的权限判断逻辑，都将依赖于此时读到的权限

多个系统(客户端)都可以和MySQL服务器建立连接，每个系统的连接也可以有多个。所以，为了解决*TCP无限创建*与*TCP频繁创建销毁*带来的*资源耗尽*与*性能下降*问题，MySQL服务器里有专门的*TCP连接池*限制连接数，采用*长连接模式*复用TCP连接，来解决上述问题。

TCP 连接收到请求后，必须要分配给一个线程专门与这个客户端的交互。所以还会有个线程池，去走后面的流程。每一个连接从线程池中获取线程，省去了创建和销毁线程的开销。

这些内容都归纳到MySQL的连接管理组件中，其职责就是负责认证、管理连接、获取权限信息。

## 第二层：服务层
第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成**缓存的查询**，SQL的分析和优化及部分内置函数的执行。所以跨存储引擎的功能也在这一层实现，如过程、函数。

在该层，服务器会**解析查询**并创建相应的内部**解析树**，并对其完成相应的**优化**：如确定查询表的顺序，是否利用索引等，最后生成相应的执行操作。

如果是SELECT语句，服务器还会**查询内部的缓存**。如果缓存空间足够大，这样在解决大量读操作的环境中能够很好的提升系统的性能。

### SQL Interface: SQL接口
* 接收用户的SQL命令，并且返回用户需要查询的结果。比如SELECT ... FROM就是调用SQL Interface
* MySQL支持DML(数据操作语言)、DDL(数据定义语言)、所有的内置函数(例如，日期、时间、数学和加密函数)、存储过程、视图、触发器、自定义函数等多种SQL语言接口

### Parser: 解析器
* 在解析器中对SQL语句进行语法分析、语义分析。将SQL语句分解成数据结构，并将这个结构传递到后续步骤，以后SQL语句的传递和处理就是基于这个结构的。如果在分解构成中遇到错误，那么就说明这个SQL语句是不合理的。
* 在SQL命令传递到解析器的时候会被解析器验证和解析，并为其创建**语法树**，并根据数据字典丰富查询语法树，会**验证该客户端是否具有执行该查询的权限**。创建好语法树后，MySQL还会对SQL查询进行语法上的优化，进行查询重写。

### Optimizer: 查询优化器
* SQL语句在语法解析之后、查询之前会使用查询优化器确定SQL语句的执行路径，生成一个**执行计划**。
* 这个执行计划表明应该**使用哪些索引**进行查询(全表检索还是使用索引检索)，表之间的连接顺序如何，最后会按照执行计划中的步骤调用存储引擎提供的方法来真正的执行查询，并将查询结果返回给用户。
* 它使用“**选取-投影-连接**”策略进行查询。例如:`SELECT id,name FROM student WHERE gender = '女';`。
  * 这个SELECT查询先根据WHERE语句进行**选取**，而不是将表全部查询出来以后再进行*gender*过滤
  * 这个SELECT查询先根据*id*和*name*进行属性**投影**，而不是将属性全部取出以后再进行过滤
  * 这个SELECT查询将这两个查询条件**连接**起来生成最终查询结果

### Caches & Buffers: 查询缓存组件
* MySQL内部维持着一些Cache和Buffer，比如Query Cache用来缓存一条SELECT语句的执行结果，如果能够在其中找到对应的查询结果，那么就不必再进行查询解析、优化和执行的整个过程了，直接将结果反馈给客户端。
* 这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key缓存，权限缓存等。
* 这个查询缓存可以在**不同客户端之间共享**。
* 从MySQL5.7.20开始，不推荐使用查询缓存，并在**MySQL8**中被完全移除。

## 第三层：引擎层
插件式存储引擎层(Storage Engines)，**真正的负责了MySQL中数据的存储和提取，对物理服务器级别维护的底层数据执行操作**。服务器通过API与存储引擎进行通信，这些API屏蔽了不同存储引擎之间的差异，使得它们对上面的查询层基本上是透明的。存储引擎层还包含几十个底层函数，用于执行诸如“开始一个事务”或者“根据主键提取一行记录”等操作。但存储引擎不会去解析SQL，不同存储引擎之间也不会相互通信，而只是简单地响应服务器的请求。

MySQL默认支持的存储引擎如下:
![逻辑架构+20231114161438](https://raw.githubusercontent.com/loli0con/picgo/master/images/%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%2B20231114161438.png%2B2023-11-14-16-14-39)

## 文件系统
所有的数据，数据库、表的定义，表的每一行的内容，索引，都是存在**文件系统**上，以**文件**的方式存 在的，并完成与存储引擎的交互。当然有些存储引擎比如InnoDB，也支持不使用文件系统直接管理裸设 备，但现代文件系统的实现使得这样做没有必要了。在文件系统之下，可以使用本地磁盘，可以使用DAS、NAS、SAN等各种存储系统。