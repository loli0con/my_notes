# 执行流程

![SQL执行流程+20231204192038](https://raw.githubusercontent.com/loli0con/picgo/master/images/SQL执行流程+20231204192038.png+2023-12-04-19-20-39)

## 1. 查询缓存
Server 如果在查询缓存中发现了这条 SQL 语句，就会直接将结果返回给客户端；如果没有，就进入到解析器阶段。需要说明的是，因为查询缓存往往效率不高，所以在 MySQL8.0 之后就抛弃了这个功能。

### 弃用原因
在 MySQL 中的查询缓存，不是缓存查询计划，而是查询对应的结果。这就意味着查询匹配的**鲁棒性大大降低**，只有**相同的查询操作才会命中缓存**。两个查询请求在任何字符上的不同(例如：空格、注释、大小写)，都会导致缓存不会命中。因此 MySQL 的**查询缓存命中率不高**。

同时，如果查询请求中包含某些系统函数、用户自定义变量和函数、一些系统表，如*mysql*、 *information_schema*、*performance_schema*数据库中的表，那这个请求就不会被缓存。

此外，既然是缓存，那就有**缓存失效的时候**。MySQL的缓存系统会监测涉及到的每张表，只要该表的结构或者数据被修改，如对该表使用了INSERT、UPDATE、DELETE、TRUNCATE TABLE、ALTER TABLE、DROP TABLE或DROP DATABASE语句，那使用该表的所有高速缓存查询都将变为无效并从高速缓存中删除。对于**更新压力大的数据库**来说查询缓存的命中率会非常低。

## 2. 解析器
在解析器中对 SQL 语句进行语法分析、语义分析。

分析器先做“**词法分析**”。你输入的是由多个字符串和空格组成的一条 SQL 语句，MySQL 需要识别出里面的字符串分别是什么，代表什么。MySQL 从你输入的"select"这个关键字识别出来，这是一个查询语句。它也要把字符串“T”识别成“表名 T”，把字符串“ID”识别成“列 ID”。

接着，要做“**语法分析**”。根据词法分析的结果，语法分析器(比如:Bison)会根据语法规则，判断你输入的这个SQL语句是否**满足 MySQL 语法**。

```SQL
select department_id,job_id,avg(salary) from employees group by department_id;
```

如果SQL语句正确，则会生成一个这样的语法树：
![SQL执行流程+20231205120426](https://raw.githubusercontent.com/loli0con/picgo/master/images/SQL执行流程+20231205120426.png+2023-12-05-12-04-27)

## 3. 优化器
在优化器中会确定 SQL 语句的执行路径，比如是根据**全表检索**，还是根据**索引检索**等。

例如有多种执行方法的逻辑结果是一样的，但是执行的效率会有不同，而优化器的作用就是决定选择使用哪一个方案。优化器阶段完成后，这个语句的执行方案就确定下来了，然后进入执行器阶段。

在查询优化器中，可以分为**逻辑查询**优化阶段和**物理查询**优化阶段。

## 4. 执行器