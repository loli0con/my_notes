# 执行流程

![SQL执行流程+20231204192038](https://raw.githubusercontent.com/loli0con/picgo/master/images/SQL执行流程+20231204192038.png+2023-12-04-19-20-39)

## 1. 查询缓存
Server如果在查询缓存中发现了这条SQL语句，就会直接将结果返回给客户端；如果没有，就进入到解析器阶段。需要说明的是，因为查询缓存往往效率不高，所以在MySQL8之后就抛弃了这个功能。

MySQL拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句。之前执行过的语句及其结果可能会以key-value对的形式被直接缓存在内存中。key是查询的语句，value是查询的结果。如果你的查询能够直接在这个缓存中找到key，那么这个value就会被直接返回给客户端。如果语句不在查询缓存中，就会继续后面的执行阶段。执行完成后，执行结果会被存入查询缓存中。所以查询命中缓存，MySQL不需要执行后面复杂的操作，就可以直接返回结果，这个效率会很高。

### 弃用原因
在MySQL中的查询缓存，不是缓存查询计划，而是查询对应的结果。这就意味着查询匹配的**鲁棒性大大降低**，只有**相同的查询操作才会命中缓存**。两个查询请求在任何字符上的不同(例如：空格、注释、大小写)，都会导致缓存不会命中。因此MySQL的**查询缓存命中率不高**。

同时，如果查询请求中包含某些系统函数、用户自定义变量和函数、一些系统表，如*mysql*、*information_schema*、*performance_schema*数据库中的表，那这个请求就不会被缓存。以某些系统函数举例，可能同样的函数的两次调用会产生不一样的结果，比如函数`NOW`，每次调用都会产生最新的当前时间，如果在一个查询请求中调用了这个函数，那即使查询请求的文本信息都一样，那不同时间的两次查询也应该得到不同的结果，如果第一次查询时就缓存了，那第二次查询的时候直接使用第一次查询的结果就是错误的。

此外，既然是缓存，那就有**缓存失效的时候**。MySQL的缓存系统会监测涉及到的每张表，只要该表的结构或者数据被修改，如对该表使用了`INSERT`、`UPDATE`、`DELETE`、`TRUNCATE TABLE`、`ALTER TABLE`、`DROP TABLE`或`DROP DATABASE`语句，那使用该表的所有高速缓存查询都将变为无效并从高速缓存中删除。对于**更新压力大的数据库**来说，查询缓存的命中率会非常低。

## 2. 解析器
在解析器中对SQL语句进行语法分析、语义分析。
![SQL执行流程+20250207164204](https://raw.githubusercontent.com/loli0con/picgo/master/images/SQL执行流程+20250207164204.png+2025-02-07-16-42-05)

分析器先做“**词法分析**”。你输入的是由多个字符串和空格组成的一条SQL语句，MySQL需要识别出里面的字符串分别是什么，代表什么。MySQL从你输入的"select"这个关键字识别出来，这是一个查询语句。它也要把字符串“T”识别成“表名 T”，把字符串“ID”识别成“列 ID”。

接着，要做“**语法分析**”。根据词法分析的结果，语法分析器(比如:Bison)会根据语法规则，判断你输入的这个SQL语句是否**满足MySQL语法**。如果你的语句不对，就会收到“You have an error in your SQL syntax”的错误提醒。如果SQL语句正确，则会生成一个这样的语法树：
![SQL执行流程+20231205120426](https://raw.githubusercontent.com/loli0con/picgo/master/images/SQL执行流程+20231205120426.png+2023-12-05-12-04-27)

## 3. 优化器
在优化器中会确定SQL语句的执行路径，比如是根据**全表检索**，还是根据**索引检索**等。

经过了解析器，MySQL就知道你要做什么了。在开始执行之前，还要先经过优化器的处理。**一条查询语句可以有很多种执行方式，最后都返回相同的结果。优化器的作用就是找到这其中最好的执行计划。** 比如：优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序，还有表达式简化、子查询转为连接、外连接转为内连接等。

在查询优化器中，可以分为**逻辑查询**优化阶段和**物理查询**优化阶段。
* 逻辑查询优化就是通过改变SQL语句的内容来使得SQL查询更高效，同时为物理查询优化提供更多的候选执行计划。通常采用的方式是对SQL语句进行**等价交换**，对查询进行**重写**，而查询重写的数学基础就是关系代数。对条件表达式进行等价谓词重写、条件简化，对视图进行重写，对子查询进行优化，对连接语义进行了外连接消除、嵌套连接消除等。
* 物理查询优化是基于关系代数进行查询的重写，而关系代数的每一步都对应着物理计算，这些物理计算往往存在多种算法，因此需要计算各种物理路径的代价，从中选择代价最小的作为执行计划。在这个阶段里，对于单表和多表连接的操作，需要高效地使用索引，提升查询效率。

## 4. 执行器
截止到现在，还没有真正去读写真实的表，仅仅是产出了一个执行计划。于是就进入了**执行器阶段**。

在执行之前需要判断用户是否具有权限，如果没有，就会返回权限错误。如果具备权限，就执行SQL查询并返回结果。在MySQL8.0以下的版本，如果设置了查询缓存，这时会将查询结果进行缓存。

如果有权限，就打开表继续执行。打开表的时候，执行器会根据表的引擎定义，调用存储引擎API对表进行读写。存储引擎API只是抽象接口，下面还有个**存储引擎层**，具体实现还是要看表选择的存储引擎。

## 总结
SQL语句在MySQL中的流程是：SQL语句->查询缓存->解析器->优化器->执行器。

![SQL执行流程+20240227133802](https://raw.githubusercontent.com/loli0con/picgo/master/images/SQL执行流程+20240227133802.png+2024-02-27-13-38-03)