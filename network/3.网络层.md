# 网络层

## 网络层提供的两种服务

### 网络层的任务
网络层关注的是如何将分组从源端沿着网络路径送达目的端。
### 网络层提供的服务
#### 两种服务
在计算机网络领域，网络层应该向运输层提供怎样的服务？
* 面向连接 ➡️ 虚电路服务
* 无连接 ➡️ 数据报服务

实质的问题是：可靠交付应当由谁来负责？是**网络**还是**端系统**?

> 举例，你在淘宝买了一个商品，三十天都没收到货，你应该去找快递公司还是找卖家？  
> 快递公司代表网络，卖家代表端系统。

##### 虚电路服务——电信网
虚电路表示这只是一条**逻辑上的连接**，分组都沿着这条逻辑连接按照存储转发方式传送，而并不是真正建立了一条物理连接。
请注意，电路交换的电话通信是先建立了一条**真正的连接**。因此分组交换的虚连接和电路交换的连接只是类似，但并不完全一样。

##### 数据报服务——因特网
* 网络层向上只提供简单灵活的、**无连接的**、**尽最大努力交付**的**数据报服务**。  
* 网络在发送分组时不需要先建立连接。每一个分组(即 IP 数据报)独立发送，与其前后的分组无关(不进行编号)。  
* **网络层不提供服务质量的承诺**。即所传送的分组可能出错、丢失、重复和失序(不按序到达终点)，当然也不保证分组传送的时限。

###### 尽最大努力交付的好处
* 由于传输网络不提供端到端的可靠传输服务，这就使网络中的路由器可以做得比较简单，而且价格低廉(与电信网的交换机相比较)。
* 如果主机(即端系统)中的进程之间的通信需要是可靠的，那么就由网络的**主机中的运输层负责可靠交付**(包括差错处理、流量控制等) 。
* 采用这种设计思路的好处是：网络的造价大大降低，运行方式灵活，能够适应多种应用。
* 互连网能够发展到今日的规模，充分证明了当初采用这种设计思路的正确性。

##### 虚电路服务与数据报服务的比较
![3.网络层+截屏2021-02-07 23.28.12](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-07%2023.28.12.png%2B2021-02-07-23-28-24)

## 网际协议IP
网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。  
与 IP 协议配套使用的还有三个协议：
* 地址解析协议 ARP (Address Resolution Protocol)
*  网际控制报文协议 ICMP (Internet Control Message Protocol)
* 网际组管理协议 IGMP (Internet Group Management Protocol)

![3.网络层+截屏2021-02-07 23.38.15](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-07%2023.38.15.png%2B2021-02-07-23-38-33)

### 虚拟互连网络

#### 网络互联的设备
将网络互相连接起来要使用一些中间设备，中间设备又称为中间系统或中继(relay)系统。  
有以下五种不同的中间设备:
* 物理层中继系统：转发器 (repeater)。
* 数据链路层中继系统：网桥 或 桥接器 (bridge)。
* 网络层中继系统：路由器 (router)。
* 网桥和路由器的混合物：桥路器 (brouter)。
* 网络层以上的中继系统：网关 (gateway)。

#### 网络互联的概念
* 当中继系统是转发器或网桥时，一般并不称之为网络互连，因为这仅仅是把一个网络扩大了，而这仍然是一个网络。
* 网络互连都是指用路由器进行网络互连和路由选择。
* 网关由于比较复杂，目前使用得较少。
* 由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为网关。

#### 网络互联的问题
将网络互连并能够互相通信，会遇到许多问题需要解决，如: 
* 不同的寻址方案
* 不同的最大分组长度
* 不同的网络接入机制
* 不同的超时控制
* 不同的差错恢复方法
* 不同的状态报告方法
* 不同的路由选择技术
* 不同的用户接入控制
* 不同的服务(面向连接服务和无连接服务) 
* 不同的管理与控制方式等

#### 互联网络 与 虚拟互联网络
![3.网络层+截屏2021-02-08 11.29.02](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-08%2011.29.02.png%2B2021-02-08-11-29-14)
* 所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们**利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络**。
    > 虚拟互联网络屏蔽了网络的复杂性，通过IP地址访问其他主机即可。
* 使用 IP 协议的虚拟互连网络可简称为 IP 网。
* 使用虚拟互连网络的好处是:当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互 连的各具体的网络异构细节。

### IP地址的表示和分类

#### IP地址的概念
IP 地址就是给每个连接在互联网上的主机(或路由器)分配一个在全世界范围是唯一的 32 位的标识符。  
IP 地址现在由互联网名字和数字分配机构 ICANN (Internet Corporation for Assigned Names and Numbers)进行分配。

#### IP地址的编址方法
* 分类的 IP 地址：这是最基本的编址方法。
* 子网的划分：这是对最基本的编址方法的改进
* 构成超网：这是比较新的无分类编址方法

#### 分类IP地址
1. 将IP地址划分为若干个固定类。
2. 每一类地址都由两个固定长度的字段组成，其中一个字段是**网络号 net-id**，它标志主机(或路由器)所连接到的网络，而另一个字段则是**主机号 host-id**，它标志该主机(或路由器)。
3. 主机号在它前面的网络号所指明的网络范围内必须是唯一的。
4. 由此可见，一个 IP 地址在整个互联网范围内是唯一的。

![3.网络层+截屏2021-02-08 12.32.35](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-08%2012.32.35.png%2B2021-02-08-12-32-44)

##### 点分十进制记法
用十进制和小数点表示32位二进制的IP地址
![3.网络层+截屏2021-02-08 19.31.23](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-08%2019.31.23.png%2B2021-02-08-19-31-33)

##### 所有分类
![3.网络层+截屏2021-02-08 12.33.16](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-08%2012.33.16.png%2B2021-02-08-12-33-25)

![3.网络层+截屏2021-02-08 19.46.48](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-08%2019.46.48.png%2B2021-02-08-19-47-10)

##### 特殊的IP地址
![3.网络层+截屏2021-02-08 19.58.41](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-08%2019.58.41.png%2B2021-02-08-19-58-49)
> [0.0.0.0和回环地址的区别](https://lisheng.blog.csdn.net/article/details/83382652)

* 127.0.0.1：本地回环地址
* 169.254.0.0：没有通过DHCP协议正确地获得IP地址时，windows自动分配的一个IP地址
* 保留地址，给企业或者组织用于组建内网：
  * 10.0.0.0：A类地址
  * 172.16.0.0 -- 172.31.0.0：B类地址
  * 192.168.0.0 -- 192.168.255.0：C类地址

##### 重要特点
1. IP 地址是一种分等级的地址结构。  
   分两个等级的好处是：
   1. IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配。这样就**方便了 IP 地址的管理**。
   2. 路由器仅根据目的主机所连接的网络号来转发分组(而不考虑目的主机号)，这样就可以使路由表中的项目数大幅度减少，从而**减小了路由表**所占的存储空间。
2. 实际上 IP 地址是标志一个主机(或路由器)和一条链路的接口。
    * 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的 IP 地址，其网络号 net-id 必须是不同的。这种主机称为多归属主机 (multihomed host)。
    * 由于一个路由器至少应当连接到两个网络(这样它才能将 IP 数据报从一个网络转发到另一个网络)，因此一个路由器至少应当有两个不同的 IP 地址。
3. 用转发器或网桥连接起来的若干个局域网仍为一个网络，因此这些局域网都具有同样的网络号 net-id。
4. 所有分配到网络号 net-id 的网络，无论是范围很小的局域网，还是可能覆盖很大地理范围的广域网，都是平等的。

#### 子网划分
##### 基本概念
在 IP 地址中又增加了一个“子网号字段”，使两级的 IP 地址变成为三级的 IP 地址。这种做法叫做划分子网 (subnetting)。

##### 基本思路
**从主机号借用**若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。
![3.网络层+截屏2021-02-09 14.21.56](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-09%2014.21.56.png%2B2021-02-09-14-22-07)

##### 优点
* 减少了 IP 地址的浪费
* 使网络的组织更加灵活
* 更便于维护和管理
> 划分子网增加了灵活性，但却减少了能够连接在网络上的主机总数。

划分子网纯属一个单位内部的事情，对外部网络透明，对外仍然表现为没有划分子网的一个网络。

##### 子网掩码
使用子网掩码 (subnet mask) 可以找出 IP 地址中的子网部分。

路由器在交换信息的时候，也需要包含子网掩码的信息。

###### 规则
子网掩码长度 = 32 位
* 某位 = 1：IP地址中的对应位为网络号和子网号 
* 某位 = 0：IP地址中的对应位为主机号


![3.网络层+截屏2021-02-09 16.18.51](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-09%2016.18.51.png%2B2021-02-09-16-19-06)

#### 无分类编址
*使用变长子网掩码 VLSM(Variable Length Subnet Mask) 可进一步提高 IP 地址资源的利用率，在 VLSM 的基础上又进一步研究出无分类编址方法，它的正式名字是无分类域间路由选择 CIDR (Classless Inter-Domain Routing)。*

CIDR使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号。
![3.网络层+截屏2021-02-18 00.32.53](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2000.32.53.png%2B2021-02-18-00-33-04)

##### CIDR 地址块
CIDR 把网络前缀都相同的连续的 IP 地址组成“CIDR地址块”。

128.14.32.0/20 表示的地址块共有 2^12 个地址(因为斜线后面的 20 是网络前缀的位数，所以这个地址的主机号是 12 位)。
*  这个地址块的起始地址是 128.14.32.0。
*  在不需要指出地址块的起始地址时，也可将这样的地址块简称为“/20 地址块”。
*  128.14.32.0/20 地址块的最小地址:128.14.32.0
*  128.14.32.0/20 地址块的最大地址:128.14.47.255
*  全 0 和全 1 的主机号地址一般不使用。

##### 路由聚合
* 一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个(例如上千个)原来传统分类地址的路由。  
* 路由聚合有利于减少路由器之间的路由选择信息的交换，从而提高了整个互联网的性能。  
* 路由聚合也称为构成超网 (supernetting)。

#### IP地址和硬件地址
从层次的角度看：
* 硬件地址(或物理地址)是数据链路层和物理层使用的地址。
* IP 地址是网络层和以上各层使用的地址，是一种逻辑地址(称 IP 地址是逻辑地址是因为 IP 地址是用软件实现的)。 
![3.网络层+截屏2021-02-18 00.42.45](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2000.42.45.png%2B2021-02-18-00-43-03)

#### IP地址的意义
全世界存在着各式各样的网络，它们使用不同的硬件地址。异构网络要能够互相通信就必须进行非常复杂的硬件地址转换工作，IP编址把这个复杂问题解决了。在虚拟的 IP 网络上用 IP 地址进行通信给广大的计算机用户带来了很大的方便。

### 地址解析协议 ARP
#### 存在的问题
通信时使用了两个地址：IP 地址(网络层地址) 和 MAC 地址(数据链路层地址)  
不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。那么已经知道了一个机器(主机或路由器)的IP地址，如何找出其相应的硬件地址?

地址解析协议 ARP 就是用来解决这样的问题的。

#### ARP的作用
从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址。

#### 地址解析的过程
当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。
* 如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。
* 如没有，ARP 进程在本局域网上广播发送一个 ARP 请求分组。收到 ARP 响应分组后，将得到的 IP 地址到硬件地址的映射写入 ARP 高速缓存。

#### ARP高速缓存
![3.网络层+截屏2021-02-18 00.48.21](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2000.48.21.png%2B2021-02-18-00-48-35)
其作用为存放最近获得的 IP 地址到 MAC 地址的绑定，以减少 ARP 广播的数量。

#### 注意事项
* ARP 是解决同一个局域网上的主机或路由器的 IP 地址和硬件地址的映射问题。 
* 如果所要找的主机和源主机不在同一个局域网上，那么就要通过 ARP 找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络。剩下的工作就由下一个网络来做。
* 从 IP 地址到硬件地址的解析是自动进行的，主机的用户对这种地址解析过程是不知道的。

### IP 数据报
#### 格式
* 一个 IP 数据报由首部和数据两部分组成。
* 首部的前一部分是固定长度，共 20 字节，是所有 IP 数据报必须具有的。
* 在首部的固定部分的后面是一些可选字段，其长度是可变的。
  
![3.网络层+截屏2021-02-18 01.00.00](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2001.00.00.png%2B2021-02-18-01-00-09)

#### 字段解析
|字段名称|占用位数|字段含义|
|-----|-----|-----|
|版本|4|指 IP 协议的版本。目前的 IP 协议版本号为 4 (即IPv4)。|
|首部长度|4|可表示的最大数值是 15 个单位(一个单位为 4 字节)，因此 IP 的首部长度的最大值是 60 字节。|
|区分服务|8|用来获得更好的服务。只有在使用区分服务(DiffServ)时，这个字段才起作用。在 一般的情况下都不使用这个字段。|
|总长度|16|指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。总长度必须不超过最大传送单元 MTU。|
|标识|16|一个计数器，用来产生 IP 数据报的标识。|
|标志|3|只有前两位有意义。标志字段的最低位是 MF (More Fragment)。MF = 1 表示后面“还有分片”。MF = 0 表示最后一个分片。标志字段中间的一位是 DF (Don't Fragment)。只有当 DF = 0 时才允许分片。|
|片偏移|13|它指出较长的分组在分片后，某片在原分组中的相对位置。片偏移以 8 个字节为偏移单位。|
|生存时间|8|记为 TTL (Time To Live)，指示数据报在网络中可通过的路由器数的最大值。|
|协议|8|指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层将数据部分上交给相应的处理过程。|
|首部检验和|16|只检验数据报的首部,不检验数据部分。这里不采用 CRC 检验码而采用简单的计算方法(二进制反码求和算法)。|
|源地址|32|发送数据报的IP地址|
|目的地址|32|接收数据报的IP地址|

#### 可变部分
IP 首部的可变部分就是一个选项字段，用来支持排错、测量以及安全等措施，内容很丰富。  
选项字段的长度可变，从 1 个字节到 40 个字节不等，取决于所选择的项目。

### 分组转发
#### 路由表
路由表按主机所在的网络地址来制作，每一个路由器中的路由表就只包含 4 个项目(每一行对应于一个网络)。根据目的网络地址就能确定下一跳路由器。  
这样做的结果是:
* IP 数据报最终一定可以找到目的主机所在目的网络上的路由器(可能要通过多次的间接交付)。
* 只有到达最后一个路由器时，才试图向目的主机进行直接交付。
#### 流程
(1) 从收到的分组的首部提取目的 IP 地址 D。

(2) 先用各网络的子网掩码和 D 逐位相“与”，看是否和相应的网络地址匹配。若匹配，则将分组**直接交付**。否则就是**间接交付**，执行 (3)。

(3) 若路由表中有目的地址为 D 的**特定主机路由**，则将分组传送给指明的下一跳路由器；否则，执行 (4)。

(4) 对路由表中的每一行，将子网掩码和 D 逐位相“与”。若结果与该行的目的网络地址**最长前缀匹配**，则将分组传送给该行指明的下一跳路由器；否则，执行 (5)。

(5) 若路由表中有一个**默认路由**，则将分组传送给路由表中所指明的*默认路由*器；否则，执行 (6)。

(6) 报告转发分组出错。

#### 名词解释
##### 特定主机路由
虽然互联网所有的分组转发都是基于目的主机所在的网络，但在大多数情况下都允许有这样的特例，即为特定的目的主机指明一个路由。

##### 默认路由
默认路由是对IP数据包中的目的地址找不到存在的其他路由时，路由器所选择的路由。目的地不在路由器的路由表里的所有数据包都会使用默认路由。采用默认路由可以减少路由表所占用的空间和搜索路由表所用的时间。

##### 最长前缀匹配
使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到不止一个匹配结果。  
应当从匹配结果中选择具有最长网络前缀的路由：最长前缀匹配 (longest-prefix matching)。

### 网际控制报文协议 ICMP
#### 意义
为了更有效地转发 IP 数据报和提高交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。  
ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。

#### 格式
![3.网络层+截屏2021-02-18 01.33.08](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2001.33.08.png%2B2021-02-18-01-33-18)

#### 种类
ICMP 报文的种类有两种，即 ICMP **差错报告报文**和 ICMP **询问报文**。

##### 差错报告报文
* 终点不可达
* 时间超过
* 参数问题
* 改变路由(重定向)(Redirect)

![3.网络层+截屏2021-02-18 01.35.31](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2001.35.31.png%2B2021-02-18-01-35-40)

##### 询问报文
* 回送请求和回答报文
* 时间戳请求和回答报文

#### 应用
##### PING
PING (Packet InterNet Groper) 用来测试两个主机之间的连通性。  
PING 使用了 ICMP 回送请求与回送回答报文。

##### Traceroute
Traceroute用来跟踪一个分组从源点到终点的路径。  
它利用 IP 数据报中的 TTL 字段和 ICMP 时间超过差错报告报文实现对从源点到终点的路径的跟踪。

## 路由选择协议
### 基本概念
#### 理想的路由算法
* 算法必须是正确的和完整的。
* 算法在计算上应简单。
* 算法应能适应通信量和网络拓扑的变化，这就是说，要有**自适应性**。
* 算法应具有稳定性。
* 算法应是公平的。
* 算法应是最佳的。

##### 最佳路由
不存在一种绝对的最佳路由算法。所谓“最佳”只能是相对于某一种特定要求下
得出的较为合理的选择而已。  
实际的路由选择算法，应尽可能接近于理想的算法。

路由选择是个非常复杂的问题：
* 它是网络中的所有结点共同协调工作的结果。
* 路由选择的环境往往是不断变化的，而这种变化有 时无法事先知道。

##### 自适应性
* 静态路由选择策略——即非自适应路由选择，其特点是简单和开销较小，但不能及时适应网络状态的变化。
* 动态路由选择策略——即自适应路由选择，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也比较大。

#### 分层次的路由选择协议
互联网采用分层次的路由选择协议。
##### 自治系统
自治系统 AS 的定义：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。  
现在对自治系统 AS 的定义是强调下面的事实：尽管一个 AS 使用了多种内部路由选择协议和度量，但**重要的是一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略**。
##### 两大类路由选择协议
*  内部网关协议 IGP (Interior Gateway Protocol)
   * 在一个自治系统内部使用的路由选择协议。
   * 具体的协议有多种，如 RIP 和 OSPF 等。
* 外部网关协议 EGP (External Gateway Protocol)
  * 若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议 将路由选择信息传递到另一个自治系统中。这样的 协议就是外部网关协议EGP。
  * 目前使用的协议就是 BGP。

![3.网络层+截屏2021-02-18 08.01.05](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2008.01.05.png%2B2021-02-18-08-01-15)

### 内部网关协议 RIP
#### 工作原理
RIP 是一种分布式的、基于距离向量的路由选择协议。  
RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。

##### “距离”的定义
从一个路由器到直接连接的网络的距离定义为 1，从一个路由器到非直接连接的网络的距离定义为所经过的路由器数加 1。

RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加 1。这里的“距离”实际上指的是“最短距离”。  
RIP 认为一个好的路由就是它通过的路由器的数目少，即“距离短”。

RIP 允许一条路径最多只能包含 15 个路由器。“距离”的最大值为 16 时即相当于不可达。

RIP 不能在两个网络之间同时使用多条路由。RIP 选择一个具有最少路由器的路由(即最短路由)，哪怕还存在另一条高速(低时延)但路由器较多的路由。

##### 三个要点
1. 仅和相邻路由器交换信息。
2. 交换的信息是当前本路由器所知道的全部信息，即自己的路由表。
3. 按固定的时间间隔交换路由信息，例如，每隔 30 秒。当网络拓扑发生变化时，路由器也及时向相邻路由器通告拓扑变化后的路由信息。

##### 路由表的建立
1. 路由器在刚刚开始工作时，只知道到直接连接的网络的距离(此距离定义为 1)。它的路由表是空的。
2. 以后，每一个路由器也只和数目非常有限的相邻路由器交换并更新路由信息。
3. 经过若干次更新后，所有的路由器最终都会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器的地址。

RIP 协议的收敛 (convergence) 过程较快。“收敛”就是在自治系统中所有的结点都得到正确的路由选择信息的过程。

#### 距离向量算法
![3.网络层+截屏2021-02-18 08.13.14](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2008.13.14.png%2B2021-02-18-08-13-35)

#### RIP2 协议的报文格式
![3.网络层+截屏2021-02-18 08.14.47](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2008.14.47.png%2B2021-02-18-08-14-57)

RIP2 报文由首部和路由部分组成。  
RIP2 报文中的路由部分由若干个路由信息组成。每个路由信息需要用 20 个字节。
##### 部分字段解释
* 地址族标识符(又称为地址类别)字段用来标志所使用的地址协议。
* 路由标记填入自治系统的号码，这是考虑使 RIP 有可能收到本自治系统以外的路由选择信息。

 一个 RIP 报文最多可包括 25 个路由，因而 RIP 报文的最大长度是`4 + 20 * 25 = 504` 字节。如 超过，必须再用一个 RIP 报文来传送。

RIP2 具有简单的鉴别功能：
* 若使用鉴别功能，则将原来写入第一个路由信息(20 个字节)的位置用作鉴别。
* 在鉴别数据之后才写入路由信息，但这时最多只能再放入 24 个路由信息。

#### 特点
好消息传播得快，坏消息传播得慢。  
当网络出现故障时，要经过比较长的时间 (例如数分钟) 才能将此信息传送到所有的路由器。

#### 优缺点对比
优点：
* 实现简单，开销较小。

缺点：
* RIP 限制了网络的规模，它能使用的最大距离为 15 (16 表示不可达)。
* 路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加。
* “坏消息传播得慢”，使更新过程的收敛时间过长。

### 内部网关协议 OSPF
开放最短路径优先 OSPF (Open Shortest Path First)是为克服 RIP 的缺点在 1989 年开发出来的。

#### 基本特点
“开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。  
“最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法 SPF。  
采用分布式的链路状态协议 (link stateprotocol)。

##### 三个要点
* 向本自治系统中所有路由器发送信息，这里使用的方法是**洪泛法**。 
* 发送的信息就是与本路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息。
* 只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此信息。

##### 链路状态数据库
由于各路由器之间频繁地交换链路状态信息，因此所有的路由器最终都能建立一个链路状态数据库。  
这个数据库实际上就是全网的拓扑结构图，它在全网范围内是一致的(这称为链路状态数据库的同步)。  
OSPF 的链路状态数据库能较快地进行更新，使各个路由器能及时更新其路由表。 OSPF 的更新过程收敛得快是其重要优点。

##### 区域
为了使 OSPF 能够用于规模很大的网络， OSPF 将一个自治系统再划分为若干个更小的范围，叫做区域。每一个区域都有一个 32 位的区域标识符(用点分十进制表示)。

划分区域的好处就是将利用洪泛法交换链路状态信息 的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量。  
在一个区域内部的路由器只知道本区域的完整网络拓扑，而不知道其他区域的网络拓扑的情况。

OSPF 使用层次结构的区域划分。在上层的区域叫做主干区域 (backbone area)。主干区域的标识符规定为0.0.0.0。主干区域的作用是用来连通其他在下层的区域。

#### 格式
![3.网络层+截屏2021-02-18 19.45.38](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2019.45.38.png%2B2021-02-18-19-46-12)

##### 类型
1. 问候 (Hello) 分组。
2. 数据库描述 (Database Description) 分组。
3. 链路状态请求 (Link State Request) 分组。
4. 链路状态更新 (Link State Update) 分组，用洪泛法对全网更新链路状态。
5. 链路状态确认 (Link State Acknowledgment)分组。

#### 执行过程
![3.网络层+截屏2021-02-18 19.50.28](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2019.50.28.png%2B2021-02-18-19-50-36)

#### 洪泛法
![3.网络层+截屏2021-02-18 19.51.06](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2019.51.06.png%2B2021-02-18-19-51-15)

### 外部网关协议 BGP
BGP 是不同自治系统的路由器之间交换路由信息的协议。  
BGP 只能是力求寻找一条能够到达目的网络且比较好的路由(不能兜圈子)，而并非要寻找一条最佳路由。

#### 发言人
每一个自治系统的管理员要选择至少一个路由器作为该自治系统的“BGP 发言人” (BGP speaker) 。  
一般说来，两个 BGP 发言人都是通过一个共享网络连接在一起的，而 BGP 发言人往往就是 BGP 边界路由器，但也可以不是 BGP 边界路由器。

#### 交换路由信息
一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接，然后在此连接上交换 BGP 报文以建立 BGP 会话 (session)，利用 BGP 会话交换路由信息。

BGP 所交换的网络可达性的信息就是要到达某个网络所要经过的一系列 AS。

使用 TCP 连接交换路由信息的两个 BGP 发言人，彼此成为对方的邻站(neighbor)或对等站(peer) 。  
在 BGP 刚刚运行时，BGP 的邻站是交换整个的 BGP 路由表。但以后只需要在发生变化时更新有变化的部分。

#### 格式
![3.网络层+截屏2021-02-18 20.03.11](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2020.03.11.png%2B2021-02-18-20-03-20)

1. 打开 (OPEN) 报文，用来与相邻的另一个BGP发言人建立关系。
2. 更新 (UPDATE) 报文，用来发送某一路由的信息，以及列出要撤消的多条路由。
3. 保活 (KEEPALIVE) 报文，用来确认打开报文和周期性地证实邻站关系。
4. 通知 (NOTIFICATION) 报文，用来发送检测到的差错。

## 路由器
路由器是一种典型的网络层设备，是互联网中的关键设备。

### 作用
路由器的主要作用是:
* 连通不同的网络。
* 选择信息传送的线路。

### 结构
![3.网络层+截屏2021-02-18 20.06.18](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2020.06.18.png%2B2021-02-18-20-06-30)

整个的路由器结构可划分为两大部分:
* 路由选择部分
* 分组转发部分

#### 路由选择部分
路由选择部分也叫做控制部分，其核心构件是路由选择处理机。  
路由选择处理机的任务是根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表。

#### 分组转发部分
分组转发部分由三部分组成:
* 交换结构：又称为交换组织，其作用是根据转发表对分组进行处理。
* 一组输入端口
* 一组输出端口

#### 区别
* “分组转发”(forwarding) 就是路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。  
* “路由选择”(routing) 则是按照分布式算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态 地改变所选择的路由。

路由表是根据路由选择算法得出的。而转发表是从路由表得出的。

## IPV6
### 主要变化
* 更大的地址空间。IPv6 将地址从 IPv4 的 32 位增大到了 128 位。
* 扩展的地址层次结构。
* 灵活的首部格式。IPv6 定义了许多可选的扩展首部。
* 改进的选项。IPv6 允许数据报包含有选项的控制信息，其选项放在有效载荷中。
* 允许协议继续扩充。
* 支持即插即用(即自动配置)。因此 IPv6 不需要使用 DHCP。
* 支持资源的预分配。IPv6 支持实时视像等要求，保证一定的带宽和时延的应用。
* IPv6 首部改为 8 字节对齐。首部长度必须是 8 字节的整数倍。原来的 IPv4 首部是 4 字节对齐。

### 格式
IPv6 数据报由两大部分组成:
* 基本首部 (base header)
* 有效载荷 (payload)。有效载荷也称为净负荷。有效载荷允许有零个或多个扩展首部 (extension header)，再后面是数据部分。

![3.网络层+截屏2021-02-18 20.15.04](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2020.15.04.png%2B2021-02-18-20-15-12)

![3.网络层+截屏2021-02-18 20.16.22](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2020.16.22.png%2B2021-02-18-20-16-31)

#### 字段解释
|字段名字|占用位数|字段含义|
|-----|-----|-----|
|版本|4|指明了协议的版本，对 IPv6 该字段总是 6。|
|通信量类|8|区分不同的 IPv6 数据报的类别或优先级。|
|流标号|20| “流”是互联网络上从特定 源点到特定终点的一系列数据报，“流”所经过的路径上的路由器都保证指明的服务质量。所有属于同一个流的数据报都具有同样的流标号。|
|有效载荷长度|16|指明 IPv6 数据报除基本首部以外的字节数，其最大值是 64 KB。|
|下一个首部|8|相当于 IPv4 的协议字段或可选字段。|
|跳数限制|8|源站在数据报发出时即设定跳数限制。|
|源地址|128|数据报的发送站的 IP 地址。|
|目的地址|128|数据报的接收站的 IP 地址。|

#### 拓展首部
IPv6 把原来 IPv4 首部中选项的功能都放在扩展首部中，并将扩展首部留给路径两端的源站和目的站的主机来处理。
数据报途中经过的路由器都不处理这些扩展首部(只有一个首部例外，即逐跳选项扩展首部)。

在 RFC 2460 中定义了六种扩展首部: 
1. 逐跳选项
2. 路由选择
3. 分片
4. 鉴别
5. 封装安全有效载荷
6. 目的站选项

### 地址
IPv6 数据报的目的地址可以是以下三种基本类 型地址之一:
1. 单播 (unicast):传统的点对点通信。
2. 多播 (multicast):一点对多点的通信。
3. 任播 (anycast):这是 IPv6 增加的一种类型。任播的目的站是一组计算机，但数据报在交付时只交付其中的一个，通常是距离最近的一个。

#### 结点与接口
IPv6 将实现 IPv6 的主机和路由器均称为结点。  
一个结点就可能有多个与链路相连的接口。

IPv6 地址是分配给结点上面的接口的。
* 一个接口可以有多个单播地址。
* 其中的任何一个地址都可以当作到达该结点的目的地址。即一个结点接口的单播地址可用来唯一地标志该结点。

#### 分类
![3.网络层+截屏2021-02-18 20.27.38](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2020.27.38.png%2B2021-02-18-20-27-53)

##### 未指明地址
这个地址只能为还没有配置到一个标准的 IP 地址的主机当作源地址使用。

##### 环回地址
作用和 IPv4 的环回地址一样。

##### 多播地址
功能和 IPv4 的一样。

##### 本地链路单播地址
有些单位的网络使用 TCP/IP 协议，但并没有连接到互联网上。连接在这样的网络上的主机都可以使用这种本地地址进行通信，但不能和互联网上的其他主机通信。
> 私网地址

##### 全球单播地址
功能和 IPv4 的一样。

### 技术过渡
向 IPv6 过渡只能采用逐步演进的办法，同时，还必须使新安装的 IPv6 系统能够向后兼容：IPv6 系统必须能够接收和转发 IPv4 分组，并且能够为 IPv4 分组选择路由。

两种向 IPv6 过渡的策略: 
* 使用双协议栈
* 使用隧道技术

#### 双协议栈
双协议栈 (dual stack) 是指在完全过渡到 IPv6 之前，使一部分主机(或路由器)装有两个协议栈，一个 IPv4 和一个 IPv6。

#### 隧道技术
在 IPv6 数据报要进入 IPv4 网络时，把 IPv6 数据报封装成为 IPv4 数据报，整个的 IPv6 数据报变成了 IPv4 数据报的数据部分。  
当 IPv4 数据报离开 IPv4 网络中的隧道时，再把数据部分(即原来的 IPv6 数据报)交给主机的 IPv6 协议栈。

![3.网络层+截屏2021-02-18 20.33.27](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2020.33.27.png%2B2021-02-18-20-33-36)

### ICMPv6
地址解析协议 ARP 和网际组管理协议 IGMP 协议的功能都已被合并到 ICMPv6 中。  
ICMPv6 是面向报文的协议，它利用报文来报告差错，获取信息，探测邻站或管理多播通信。

#### 分类
ICMPv6 还增加了几个定义报文的功能及含义的其他协议。

![3.网络层+截屏2021-02-18 20.35.12](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2020.35.12.png%2B2021-02-18-20-36-37)

## IP多播
### 基本概念
在互联网上进行多播就叫做 IP 多播。  
一对多通信：一个源点发送到许多个终点。

互联网范围的多播要靠路由器来实现。能够运行多播协议的路由器称为多播路由器。当然它也可以转发普通的单播IP数据报。

#### 多播地址
IP 多播所传送的分组需要使用多播 IP 地址。在多播数据报的目的地址写入的是多播组的标识符。 

多播组的标识符就是 IP 地址中的 D 类地址(多播地址)。  
每一个 D 类地址标志一个多播组。  
多播地址只能用于目的地址，不能用于源地址。

#### 多播数据报
* 多播数据报和一般的 IP 数据报的区别就是它使 用 D 类 IP 地址作为目的地址，并且首部中的协议字段值是 2，表明使用网际组管理协议 IGMP。
* 多播数据报也是“尽最大努力交付”，不保证一定能够交付多播组内的所有成员。
* 对多播数据报不产生 ICMP 差错报文。因此，若在 PING 命令后面键入多播地址，将永远不会收到响应。

### 硬件多播
互联网号码指派管理局 IANA 拥有的以太网地址块的高 24 位为 00-00-5E。  
因此 TCP/IP 协议使用的以太网多播地址块的范围是从 00-00-5E-00-00-00
到 00-00-5E-FF-FF-FF。

![3.网络层+截屏2021-02-18 20.43.28](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2020.43.28.png%2B2021-02-18-20-43-43)

### 网际组管理协议IGMP和多播路由选择协议
#### 两种协议
* 为了使路由器知道多播组成员的信息，需要利用网际组管理协议 IGMP (Internet Group Management Protocol)。
* 连接在局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用多播路由选择协议。

#### IGMP
IGMP 使用 IP 数据报传递其报 文(即 IGMP 报文加上 IP 首部构成 IP 数据报)，但它也向 IP 提供服务。

IGMP 协议是让连接在本地局域网上的多播路由器知道本局域网上是否有主机(严格讲，是主机上的某个进程)参加或退出了某个多播组。

##### 两个阶段
###### 加入多播组
* 当某个主机加入新的多播组时，该主机应向多播组的多播地址发送 IGMP 报文，声明自己要成为该组的成员。  
* 本地的多播路由器收到 IGMP 报文后，将组成员关系转发给互联网上的其他多播路由器。
###### 探询组成员变化情况
* 因为组成员关系是动态的，因此本地多播路由器要周期性地探询本地局域网上的主机，以便知道这些主机是否还继续是组的成员。
* 只要对某个组有一个主机响应，那么多播路由器就认为这个组是活跃的。
* 但一个组在经过几次的探询后仍然没有一个主机响应，则不再将该组的成员关系转发给其他的多播路由器。

#### 多播路由选择
* 多播路由选择协议尚未标准化。
* 一个多播组中的成员是动态变化的，随时会有主机加入或离开这个多播组。
* 多播路由选择实际上就是要找出以源主机为根结点的多播转发树。
* 在多播转发树上的路由器不会收到重复的多播数据报。
* 对不同的多播组对应于不同的多播转发树。
* 同一个多播组，对不同的源点也会有不同的多播转发树。

##### 三种方法
多播路由选择协议在转发多播数据报时使用三种方法:
1. 洪泛与剪除
2. 隧道技术(tunneling)
3. 基于核心的发现技术

## 虚拟专用网VPN 和 网络地址转换NAT
### VPN
#### 专用网
假定在一个机构内部的计算机通信也是采用 TCP/IP 协议，那么从原则上讲，对于这些仅在机构内部使用的计算机就可以由本机构自行分配其 IP 地址。  
RFC 1918 指明了一些专用地址 (private address)。专用地址只能用作本地地址而不能用作全球地址。在互联网中的所有路由器，对目的地址是专用地址的数据报一律不进行转发。
![3.网络层+截屏2021-02-18 21.01.52](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2021.01.52.png%2B2021-02-18-21-02-01)
采用这样的专用 IP 地址的互连网络称为专用互联网或本地互联网，或更简单些，就叫做专用网。

#### 虚拟专用网
利用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网 VPN (Virtual Private Network)。

如果专用网不同网点之间的通信必须经过公用的互联网，但又有保密的要求，那么所有通过互联网传送的数据都必须加密。

![3.网络层+截屏2021-02-18 21.05.03](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2021.05.03.png%2B2021-02-18-21-05-12)

### NAT
当 NAT 路由器具有 n 个全球 IP 地址时，专用网内最多可以同时有 n 台主机接入到互联网。这样就可以使专用网内较多数量的主机，轮流使用 NAT 路由器有限数量的全球 IP 地址。
![3.网络层+截屏2021-02-18 21.07.28](https://raw.githubusercontent.com/loli0con/picgo/master/images/3.%E7%BD%91%E7%BB%9C%E5%B1%82%2B%E6%88%AA%E5%B1%8F2021-02-18%2021.07.28.png%2B2021-02-18-21-07-36)

#### NAPT
* 为了更加有效地利用 NAT 路由器上的全球IP地址，现在常用的 NAT 转换表把运输层的端口号也利用上。这样，就可以使多个拥有本地地址的主机，共用一个 NAT 路由器上的全球 IP 地址，因而可以同时和互联网上的不同主机进行通信。
* 使用端口号的 NAT 叫做网络地址与端口号转换 NAPT (Network Address and Port Translation)，而不使用端口号的 NAT 就叫做传统的 NAT。

# 后记
说实话，这章节内容太多了。重点算是总结完了，但是完全不进脑子。没眼看，😭。